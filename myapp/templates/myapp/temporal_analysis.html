{% extends 'myapp/base1.html' %}
{% load static %}

{% block title %}Temporal Analysis | Safaricom{% endblock %}

{% block head %}
<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Load Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Load Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<style>
  .dashboard-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    padding: 30px;
  }
  .dashboard-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    padding: 20px;
  }
  .card-header {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #1BB64F;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
  }
  .chart-container {
    height: 500px;
    width: 100%;
  }
  .filter-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding: 0 30px;
    flex-wrap: wrap;
  }
  .filter-control {
    display: flex;
    flex-direction: column;
    min-width: 200px;
    flex-grow: 1;
  }
  .filter-control label {
    font-size: 0.9rem;
    margin-bottom: 5px;
    color: #555;
  }
  .filter-control select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
  }
  .time-unit-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .time-unit-btn {
    padding: 8px 16px;
    background: #f0f0f0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .time-unit-btn:hover {
    background: #e0e0e0;
  }
  .time-unit-btn.active {
    background: #1BB64F;
    color: white;
  }
  .metric-selector {
    margin-bottom: 20px;
  }
  .metric-btn {
    padding: 8px 16px;
    background: #f0f0f0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
    transition: all 0.3s ease;
  }
  .metric-btn:hover {
    background: #e0e0e0;
  }
  .metric-btn.active {
    background: #1BB64F;
    color: white;
  }
  .insights-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }
  @media (max-width: 768px) {
    .insights-container {
      grid-template-columns: 1fr;
    }
    .filter-controls {
      flex-direction: column;
    }
    .time-unit-selector {
      flex-wrap: wrap;
    }
  }
</style>

<!-- Header -->
<div style="text-align:center; margin-top:2rem;">
    <h1 style="color:#1BB64F; font-size:2.5rem; font-weight:800;">Temporal Claim Patterns</h1>
    <p style="font-size:1.25rem; color:#232323; margin-bottom:2.5rem;">Analyze claim patterns over time</p>
</div>


<!-- Filter Controls -->
<form method="GET" class="filter-controls">
    <div class="filter-control">
        <label for="time_period">Time Period</label>
        <select id="time_period" name="time_period" class="searchable-select">
            <option value="all" {% if request.GET.time_period == 'all' %}selected{% endif %}>All Time</option>
            <option value="3m" {% if request.GET.time_period == '3m' %}selected{% endif %}>Last 3 Months</option>
            <option value="6m" {% if request.GET.time_period == '6m' %}selected{% endif %}>Last 6 Months</option>
            <option value="12m" {% if request.GET.time_period == '12m' %}selected{% endif %}>Last 12 Months</option>
        </select>
    </div>
    <div class="filter-control">
        <label for="benefit_type">Benefit Type</label>
        <select id="benefit_type" name="benefit_type" class="searchable-select">
            <option value="all">All Types</option>
            {% for type in benefit_types %}
            <option value="{{ type }}" {% if request.GET.benefit_type == type %}selected{% endif %}>{{ type }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-control">
        <label for="provider">Provider</label>
        <select id="provider" name="provider" class="searchable-select">
            <option value="all">All Providers</option>
            {% for provider in providers %}
            <option value="{{ provider }}" {% if request.GET.provider == provider %}selected{% endif %}>{{ provider }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-control">
        <label for="cost_center">Cost Center</label>
        <select id="cost_center" name="cost_center" class="searchable-select">
            <option value="all">All Centers</option>
            {% for center in cost_centers %}
            <option value="{{ center }}" {% if request.GET.cost_center == center %}selected{% endif %}>{{ center }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-control" style="justify-content: flex-end;">
        <label>&nbsp;</label>
        <button type="submit" style="padding: 8px 16px; background:#1BB64F; color:white; border:none; border-radius:6px;">
            Apply Filters
        </button>
    </div>
</form>

<!-- Time Unit Selector -->
<div class="filter-controls">
    <div class="time-unit-selector">
        <button class="time-unit-btn {% if time_unit == 'day' %}active{% endif %}" data-unit="day">Daily</button>
        <button class="time-unit-btn {% if time_unit == 'week' %}active{% endif %}" data-unit="week">Weekly</button>
        <button class="time-unit-btn {% if time_unit == 'month' %}active{% endif %}" data-unit="month">Monthly</button>
        <button class="time-unit-btn {% if time_unit == 'quarter' %}active{% endif %}" data-unit="quarter">Quarterly</button>
        <button class="time-unit-btn {% if time_unit == 'year' %}active{% endif %}" data-unit="year">Yearly</button>
        <input type="hidden" id="time_unit" name="time_unit" value="{{ time_unit }}">
    </div>
</div>

<!-- Metric Selector -->
<div class="filter-controls">
    <div class="metric-selector">
        <button class="metric-btn {% if metric == 'Total Amount' %}active{% endif %}" data-metric="Total Amount">Total Amount</button>
        <button class="metric-btn {% if metric == 'Claim Count' %}active{% endif %}" data-metric="Claim Count">Claim Count</button>
        <button class="metric-btn {% if metric == 'Average Amount' %}active{% endif %}" data-metric="Average Amount">Average Amount</button>
        <input type="hidden" id="metric" name="metric" value="{{ metric }}">
    </div>
</div>

<!-- Main Temporal Chart -->
<div class="dashboard-container">
    <div class="dashboard-card">
        <div class="card-header">Claims Over Time</div>
        <div class="chart-container" id="temporalChart">
            {% if temporal_chart %}
                {{ temporal_chart|safe }}
            {% elif error_message %}
                <div style="text-align:center; padding:50px 20px; color:#ff6b6b; font-style:italic;">
                    {{ error_message }}
                </div>
            {% else %}
                <div style="text-align:center; padding:50px 20px; color:#777; font-style:italic;">
                    No temporal data available
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Insights -->
<div class="dashboard-card" style="margin: 30px;">
    <div class="card-header">Quick Insights</div>
    <div class="insights-container">
        <div>
            <div class="chart-container" id="numericalFeatureChart" style="height:300px; margin-top:15px;">
                {% if numerical_chart %}
                    {{ numerical_chart|safe }}
                {% else %}
                    <div style="text-align:center; padding:50px 20px; color:#777; font-style:italic;">
                        Monthly claim amount trend
                    </div>
                {% endif %}
            </div>
        </div>
        <div>
            <div class="chart-container" id="categoricalFeatureChart" style="height:300px; margin-top:15px;">
                {% if categorical_chart %}
                    {{ categorical_chart|safe }}
                {% else %}
                    <div style="text-align:center; padding:50px 20px; color:#777; font-style:italic;">
                        Claims by benefit type
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2
    if (typeof $ !== 'undefined') {
        $('.searchable-select').select2({
            placeholder: "Select an option",
            allowClear: true,
            width: '100%'
        });

        // Set up time unit buttons
        $('.time-unit-btn').click(function(e) {
            e.preventDefault();
            $('.time-unit-btn').removeClass('active');
            $(this).addClass('active');
            $('#time_unit').val($(this).data('unit'));
            $('form').submit();
        });

        // Set up metric buttons
        $('.metric-btn').click(function(e) {
            e.preventDefault();
            $('.metric-btn').removeClass('active');
            $(this).addClass('active');
            $('#metric').val($(this).data('metric'));
            $('form').submit();
        });
    } else {
        console.error("jQuery is not loaded. Select2 and button handlers won't work.");
    }

    // Set initial values from URL params
    const urlParams = new URLSearchParams(window.location.search);
    ['time_period', 'benefit_type', 'provider', 'cost_center'].forEach(param => {
        const select = document.getElementById(param);
        if (select && urlParams.has(param)) {
            select.value = urlParams.get(param);
            if (typeof $ !== 'undefined') {
                $(select).trigger('change');
            }
        }
    });
});
</script>
{% endblock %}