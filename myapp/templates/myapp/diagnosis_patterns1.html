{% extends "base1.html" %}
{% load static %}

{% block title %}Diagnosis Patterns - Safaricom Portal{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-stethoscope"></i> Diagnosis Patterns</h1>
    <p>Identification of diagnoses with unusual claim patterns</p>
</div>

<div class="content-body">
    <div class="card">
        <div class="card-header">
            <h3>Diagnoses with Highest Fraud Rates</h3>
            <div class="card-actions">
                <input type="number" id="min-claims" class="form-input"
                       placeholder="Min claims"
                       value="{{ min_claims }}"
                       min="1">
            </div>
        </div>
        <div class="card-body">
            {% if visualizations.diagnosis %}
                {{ visualizations.diagnosis|safe }}
            {% else %}
                <div class="alert alert-warning">No diagnosis data available</div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Diagnosis Details</h3>
                </div>
                <div class="card-body">
                    {% if diagnosis_data %}
                        <div class="diagnosis-details">
                            <h4>{{ diagnosis_data.0.Diagnosis }}</h4>
                            <div class="diagnosis-stats">
                                <div class="stat">
                                    <span class="stat-value">{{ diagnosis_data.0.Fraud_Rate|floatformat:1 }}%</span>
                                    <span class="stat-label">Fraud Rate</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">{{ diagnosis_data.0.Fraud_Count }}</span>
                                    <span class="stat-label">Fraud Cases</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value">{{ diagnosis_data.0.Total_Claims }}</span>
                                    <span class="stat-label">Total Claims</span>
                                </div>
                            </div>
                            <div class="diagnosis-description">
                                <h5>Common Fraud Patterns:</h5>
                                <ul>
                                    <li>Upcoding to higher-cost diagnosis</li>
                                    <li>Unnecessary treatments billed</li>
                                    <li>Duplicate claims for same service</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="no-diagnosis">
                            Select a diagnosis to view details
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Diagnosis Over Time</h3>
                </div>
                <div class="card-body">
                    <div id="diagnosis-trend-chart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .content-header {
        margin-bottom: 2rem;
    }
    
    .content-header h1 {
        color: #d62728;
        margin-bottom: 0.5rem;
    }
    
    .content-header p {
        color: #666;
    }
    
    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: 1px solid #e3e8ee;
    }
    
    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e3e8ee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .form-input {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        width: 120px;
    }
    
    .diagnosis-details {
        height: 100%;
    }
    
    .diagnosis-details h4 {
        color: #333;
        margin-bottom: 1rem;
    }
    
    .diagnosis-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat {
        text-align: center;
        background: #f7fdf9;
        padding: 1rem;
        border-radius: 6px;
    }
    
    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        display: block;
        color: #d62728;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #666;
        display: block;
    }
    
    .diagnosis-description h5 {
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .diagnosis-description ul {
        padding-left: 1.5rem;
        color: #666;
    }
    
    .diagnosis-description li {
        margin-bottom: 0.3rem;
    }
    
    .no-diagnosis {
        text-align: center;
        color: #666;
        padding: 2rem 0;
    }
    
    #diagnosis-trend-chart {
        height: 250px;
    }
</style>

<script>
    // Reload on min claims change
    document.getElementById('min-claims').addEventListener('change', function() {
        const minClaims = this.value;
        window.location.href = "?min_claims=" + minClaims;
    });

    // Placeholder trend chart (can be replaced with backend data)
    document.addEventListener('DOMContentLoaded', function() {
        const trace1 = {
            x: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            y: [5, 8, 12, 7, 9, 15],
            name: 'Fraud Cases',
            type: 'bar',
            marker: { color: '#d62728' }
        };
        const trace2 = {
            x: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            y: [45, 42, 38, 43, 41, 35],
            name: 'Normal Cases',
            type: 'bar',
            marker: { color: '#1BB64F' }
        };
        Plotly.newPlot('diagnosis-trend-chart', [trace1, trace2], {
            title: 'Monthly Claim Breakdown',
            barmode: 'stack',
            xaxis: { title: 'Month' },
            yaxis: { title: 'Number of Claims' },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)'
        });
    });
</script>
{% endblock %}