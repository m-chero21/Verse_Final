{% extends 'myapp/base.html' %}
{% block title %}Claims Prediction Engine - Minet Insurance{% endblock %}
{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    /* Claim Distribution Styling */
    .main-area {
        width: 100%;
        margin: 0;
        background: #fff;
        padding: 0;
    }
    .main-area h1 {
        font-size: 2.1rem;
        font-weight: 700;
        color: #232323;
    }
    .main-area h2 {
        font-size: 1.35rem;
        font-weight: 700;
        color: #e30613;
        margin-bottom: 2rem;
    }
    .tabs {
        display: flex;
        gap: 2.2rem;
        border-bottom: 1.5px solid #e3e8ee;
        margin-bottom: 2.2rem;
    }
    .tab {
        font-size: 1rem;
        color: #888;
        padding-bottom: 0.7rem;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: 500;
        transition: color 0.2s, border-bottom 0.2s;
        border-bottom: 2.5px solid transparent;
    }
    .tab.active {
        color: #e30613;
        border-bottom: 2.5px solid #e30613;
        font-weight: 700;
    }
    .tab:hover:not(.active) { color: #e30613; }
    .tab-content {
        margin-top: 1.5rem;
        background: #f5f5f5;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(35,35,35,0.04);
        padding: 2.2rem 0 1.5rem 0;
        min-height: 180px;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: none; }
    }
    .distribution-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 25px;
        margin-bottom: 2rem;
    }
    .distribution-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        padding: 20px;
        border-left: 4px solid #e30613;
    }
    .distribution-header {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #e30613;
        border-bottom: 1px solid #e3e8ee;
        padding-bottom: 5px;
    }
    .chart-container { height: 400px; width: 100%; }
    .filter-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .filter-control { flex: 1; min-width: 200px; }
    .filter-control label {
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: #555;
    }
    .filter-control select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ddd;
    }
    .insights-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    @media (max-width: 768px) {
        .distribution-container { grid-template-columns: 1fr; }
        .insights-container { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-area">
    <h1>The Verse - Acme_Brokers Dashboard</h1>
    <h2>Claims Prediction Engine</h2>

    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab active" onclick="showTab(event, 'data-prep')">Claim distribution</button>
        <button class="tab" onclick="showTab(event, 'model-training')">Provider efficiency</button>
        <button class="tab" onclick="showTab(event, 'make-predictions')">Diagnostic patterns</button>
    </div>

    <!-- Claim Distribution Tab -->
    <div id="data-prep" class="tab-content" style="display:block;">

        <!-- Dataset Selection Dropdown -->
        <div class="dataset-selection">
            <form method="GET" action="">
                <label for="dataset_id">Select Dataset:</label>
                <select name="dataset_id" id="dataset_id" required>
                    <option value="">-- Choose a dataset --</option>
                    {% for table in dataset_ids %}
                        <option value="{{ table }}" {% if table == selected_id %}selected{% endif %}>{{ table }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Load Data</button>
            </form>
        </div>

        <!-- Full Table Display -->
        {% if full_table_html %}
        <div class="dataset-table-container">
            <h3>Dataset Preview</h3>
            <div class="table-scroll">
                {{ full_table_html|safe }}
            </div>
        </div>
        {% endif %}

        <!-- Debug Info -->
        {% if debug_info %}
        <div class="debug-info">
            <h4>Debug Info:</h4>
            <pre>{{ debug_info|safe }}</pre>
        </div>
        {% endif %}

        <!-- Section Title -->
        <div class="section-title">
            Claims Distribution Analysis
        </div>

        <!-- Filters -->
        <div class="filter-controls">
            <div class="filter-control">
                <label for="time_period">Time Period</label>
                <select id="time_period" name="time_period" onchange="updateDistributionCharts()">
                    <option value="all" {% if time_period == 'all' %}selected{% endif %}>All Time</option>
                    <option value="year" {% if time_period == 'year' %}selected{% endif %}>Last Year</option>
                    <option value="quarter" {% if time_period == 'quarter' %}selected{% endif %}>Last Quarter</option>
                    <option value="month" {% if time_period == 'month' %}selected{% endif %}>Last Month</option>
                </select>
            </div>
            <div class="filter-control">
                <label for="benefit_type">Benefit Type</label>
                <select id="benefit_type" name="benefit_type" onchange="updateDistributionCharts()">
                    <option value="all" {% if benefit_type == 'all' %}selected{% endif %}>All Benefits</option>
                    <option value="inpatient" {% if benefit_type == 'inpatient' %}selected{% endif %}>Inpatient</option>
                    <option value="outpatient" {% if benefit_type == 'outpatient' %}selected{% endif %}>Outpatient</option>
                    <option value="dental" {% if benefit_type == 'dental' %}selected{% endif %}>Dental</option>
                    <option value="optical" {% if benefit_type == 'optical' %}selected{% endif %}>Optical</option>
                </select>
            </div>
            <div class="filter-control">
                <label for="group_by">Group By</label>
                <select id="group_by" name="group_by" onchange="updateDistributionCharts()">
                    <option value="treatment" {% if group_by == 'treatment' %}selected{% endif %}>Treatment</option>
                    <option value="provider" {% if group_by == 'provider' %}selected{% endif %}>Provider</option>
                    <option value="diagnosis" {% if group_by == 'diagnosis' %}selected{% endif %}>Diagnosis</option>
                    <option value="age_group" {% if group_by == 'age_group' %}selected{% endif %}>Age Group</option>
                </select>
            </div>
        </div>

        <!-- Charts -->
        <div class="distribution-container">
            <div class="distribution-card">
                <div class="distribution-header">Claim Distribution by Treatment</div>
                <div class="chart-container">
                    {% if treatment_distribution %}
                        {{ treatment_distribution|safe }}
                    {% else %}
                        <div class="no-data">No treatment distribution data available</div>
                    {% endif %}
                </div>
            </div>
            <div class="distribution-card">
                <div class="distribution-header">Claim Amounts by Category</div>
                <div class="chart-container">
                    {% if category_amounts %}
                        {{ category_amounts|safe }}
                    {% else %}
                        <div class="no-data">No category amounts data available</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Insights -->
        <div class="distribution-card">
            <div class="distribution-header">Quick Insights</div>
            <div class="insights-container">
                <div>
                    <label for="numericalFeature">Select Numerical Feature</label>
                    <select id="numericalFeature" onchange="updateNumericalChart(this.value)">
                        <option value="amount">Claim Amount</option>
                        <option value="quantity">Quantity</option>
                        <option value="age">Member Age</option>
                    </select>
                    <div id="numericalFeatureChart" class="chart-container"></div>
                </div>
                <div>
                    <label for="categoricalFeature">Select Categorical Feature</label>
                    <select id="categoricalFeature" onchange="updateCategoricalChart(this.value)">
                        <option value="benefit">Benefit Type</option>
                        <option value="provider">Provider</option>
                        <option value="diagnosis">Diagnosis</option>
                    </select>
                    <div id="categoricalFeatureChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Tabs -->
    <div id="model-training" class="tab-content" style="display:none;">
        <!-- Provider efficiency content -->
    </div>
    <div id="make-predictions" class="tab-content" style="display:none;">
        <!-- Diagnostic patterns content -->
    </div>
</div>

<script>
function showTab(event, tabId) {
    document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
    document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function updateDistributionCharts() {
    console.log("Update charts with filters...");
}

function updateNumericalChart(feature) {
    document.getElementById('numericalFeatureChart').innerHTML =
        `<div style="text-align:center; padding:50px; color:#777;">Histogram for ${feature}</div>`;
}

function updateCategoricalChart(feature) {
    document.getElementById('categoricalFeatureChart').innerHTML =
        `<div style="text-align:center; padding:50px; color:#777;">Bar chart for ${feature}</div>`;
}

document.addEventListener('DOMContentLoaded', function() {
    updateNumericalChart('amount');
    updateCategoricalChart('benefit');
});
</script>
{% endblock %}
